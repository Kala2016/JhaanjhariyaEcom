<%- include('../partials/header.ejs')%>

<script>
    // Initialize Toastr
    toastr.options = {
      closeButton: true,
      progressBar: true,
      positionClass: 'toast-top-right',
      preventDuplicates: true,
      newestOnTop: true,
      showDuration: 300,
      hideDuration: 1000,
      timeOut: 5000,
      extendedTimeOut: 1000,
      showEasing: 'swing',
      hideEasing: 'linear',
      showMethod: 'fadeIn',
      hideMethod: 'fadeOut'
    };
</script>

<!-- Breadcrumb Section Begin -->
<div class="breacrumb-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb-text">
                    <a href="./"><i class="fa fa-home"></i> Home</a>
                    <span>Shop</span>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Breadcrumb Section Begin -->

<!-- Product Shop Section Begin -->
<section class="product-shop spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-3 col-md-6 col-sm-8 order-2 order-lg-1 produts-sidebar-filter">
                <div class="filter-widget">
                  <h4 class="fw-title">Categories</h4>
                  <ul class="filter-catagories">
                    <ul>
                        <% for (let i = 0; i < category.length; i++) { %>
                          <li>
                            <a href="/shop?category=<%= category[i].categoryName %>"
                              <% if (category[i]._id.equals(selectedCategory)) { %>class="active"<% } %>> 
                              <%= category[i].categoryName %>
                            </a>
                          </li>
                        <% } %>
                      </ul>
                      
                   
                    
                    
                      
                  </ul>
                </div>
               

                <!-- <div class="filter-widget">
                    <h4 class="fw-title">Filter by Price</h4>
                    <div class="filter-range-wrap">
                        <div class="range-slider">
                            <div class="price-input">
                                <input type="text" id="lowToHigh">
                                <input type="text" id="highToLow">
                            </div>
                        </div>
                        <div class="price-range ui-slider ui-corner-all ui-slider-horizontal ui-widget ui-widget-content"
                            lowToHigh="0" highToLow="10000">
                            <div class="ui-slider-range ui-corner-all ui-widget-header"></div>
                            <span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span>
                            <span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span>
                        </div>
                    </div>
                    <a href="#" class="filter-btn">Filter</a>
                </div> -->
                <div class="sidebar-widget mb-20">
                    <h5 style="font-style:25px" class="fw-title">Filter by Price</h5>
                    
                    <br>
                    
                    <div class="sidebar-categories">
                        <ul>
                            
                            <li><span style="color: #525353; cursor: pointer;" onclick='handleSort("lowtoHigh")' id="lowToHigh">
                                    Low to High
                            </span></li>
                            <li><span onclick="handleSort('highToLow')" style="color: #525353; cursor: pointer;" id="highToLow">
                                    High to low
                            </span></li>
                        </ul>
                    </div>
                </div>
                
                <!-- ... (existing code) ... -->
                
                
                
                
                <!-- Your filter options go here -->
            </div>  
            <div class="col-lg-9 order-1 order-lg-2">
                <div class="product-show-option">
                    <div class="row">
                        <div class="col-lg-7 col-md-7">
                            <div class="select-option">
                               
                                   
                                    <a href="/shop">Default Sorting</a>
                            </div>
                        </div>

                        <div class="sidebar-widget mb-50">
                            <h6 class="sidebar-title"></h6>
                            <div class="sidebar-search">
                                <form>
                                    <input id="searchInput" value="<%= search %>" placeholder="Search Products..." type="text" name="search">
                                    <button id="searchButton"><i class="ti-search"></i></button>
                                </form>
                            </div>
                        </div>
                          
                        <div class="col-lg-5 col-md-5 text-right">
                            <!-- Additional options if needed -->
                        </div>
                    </div>
                </div>
                

                <div class="product-list">
                    <div class="row">
                        <% products.forEach(product => { %>
                        <div class="col-lg-4 col-sm-6">
                            <div class="product-item">
                                <div class="pi-pic">
                                    <!-- Product image -->
                                    <% if (Array.isArray(product.images) && product.images.length > 0) { %>
                                    <a href="/product/<%= product._id %>">
                                        <img src="<%= product.images[0].imageUrl %>" alt="<%= product.productName %>">
                                    </a>
                                    <% } else { %>
                                    <span>No image available</span>
                                    <% } %>
                
                                    
                                    <!-- Wishlist icon -->
                                    <div class="icon">
                                        <!-- Heart icon with inline onclick event to toggle color -->
                                        <i class="icon_heart_alt" onclick="toggleWishlist('<%= product._id %>')" id="heart-icon-<%= product._id %>" style="font-size: 20px; cursor: pointer; color: <%= userWishlist && userWishlist.includes(product._id) ? 'red' : 'black' %>"></i>
                                    </div>
                                    
                                    
                                                                                              
                                    

                                    
                                    <div id="flash-message" class="flash-message"></div>

                                    

                                    <!-- Cart and View Product links -->
                                    <ul>
                                            
                                        <li class="quick-view"><a href="/product/<%= product._id %>">+ View Product</a></li>
                                    </ul>
                                </div>
                                
                
                                <!-- Product details -->
                                <div class="pi-text">
                                    <div class="product-name" style="font-size: 20px;"><%= product.productName %></div>
                                    
                                    <% let salePrice = product.salePrice; %>
                                    <% let offerPercentage = ((product.variants[0].price - salePrice) / product.variants[0].price) * 100 || 0; %>
                                    Rs.<% let offerPrice = product.variants[0].price - salePrice || product.variants[0].price %>
                                    
                                    <!-- Display offer price and sale percentage -->
                                    <% if (salePrice) { %>
                                        <span class="mtext-106 cl2">
                                            <i class="bi bi-currency-rupee" style="font-size: medium;"></i>
                                            <span id="offerPrice">
                                                <%= salePrice.toLocaleString("en-IN") %>
                                            </span>
                                        </span>
                                        <span class="mtext-106 ms-3 cl2 text-danger" style="display: block;">
                                            <small id="offerPercentage" class="text-secondary"><%= offerPercentage.toFixed(2) %>%OFF</small>
                                            <i class="bi bi-currency-rupee" style="font-size: small;"></i>
                                            <small id="price" class="text-decoration-line-through" style="text-decoration-line-through;">
                                                Rs.<%= product.variants[0].price.toLocaleString("en-IN") %>
                                            </small>
                                        </span>
                            
                                    <% } else { %>
                                        <!-- If there's no sale, display regular price -->
                                        <span class="mtext-106 cl2">
                                            <i class="bi bi-currency-rupee" style="font-size:medium;"></i>
                                            <span id="offerPrice">
                                                <%= product.variants[0].price.toLocaleString("en-IN") %>
                                            </span>
                                        </span>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        <% }); %>
                    </div>
                </div>

                <div id="wishlist-message" class="toast" style="display: none;"></div>
                
                
                <!-- Pagination -->
                <nav aria-label="Page navigation example">
                    <ul class="pagination" id="pagination">
                      <!-- Pagination links will be dynamically added here -->
                    </ul>
                  </nav> 
            </div>
        </div>
    </div>
</section>
  
<style>
    /* Style for the search button */
    .search-button {
        background-color: #007bff; /* Change to your preferred color */
        color: #fff; /* Text color */
        border: 1px solid #007bff; /* Border color */
        padding: 8px 16px; /* Adjust padding as needed */
        border-radius: 4px; /* Rounded corners */
        cursor: pointer; /* Show pointer on hover */
        font-size: 16px; /* Adjust font size as needed */
    }
    
    /* Optional: Hover effect */
    .search-button:hover {
        background-color: #0056b3; /* Darker shade of the primary color */
        border-color: #0056b3; /* Darker shade of the primary color */
    }
</style>

<style>
    .custom-dropdown {
        border: 1px solid #eee; /* Adjust the color and width as needed */
        padding: 10px; /* Adjust the padding as needed */
        border-radius: 5px; /* Optional: Add border-radius for rounded corners */
        }
    </style>

<!-- Product Shop Section End -->



<!-- <script>
    console.log("Categories:", <%= JSON.stringify(category) %>);
</script> -->


<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

<script>


const handleSort = (value) => {
    const search = document.getElementById('searchInput').value;
    const currentURL = window.location.href;
    const url = new URL(currentURL);
    url.searchParams.set('sort', value); // Set sorting parameter
    window.location.href = url.toString();
}

    // Assuming you have the total pages and current page information available from the backend
    const totalPages = 2;
    const currentPage = 1;
  
    const paginationContainer = document.getElementById("pagination");
  
    // Previous button
    const previousButton = document.createElement("li");
    previousButton.classList.add("page-item");
    const previousLink = document.createElement("a");
    previousLink.classList.add("page-link");
    previousLink.href = `?page=${currentPage - 1}`;
    previousLink.textContent = "Previous";
    previousButton.appendChild(previousLink);
    paginationContainer.appendChild(previousButton);
  
    // Page buttons
    for (let i = 1; i <= totalPages; i++) {
      const pageButton = document.createElement("li");
      pageButton.classList.add("page-item");
      const pageLink = document.createElement("a");
      pageLink.classList.add("page-link");
      pageLink.href = `?page=${i}`;
      pageLink.textContent = i;
      if (i === currentPage) {
        pageButton.classList.add("active");
      }
      pageButton.appendChild(pageLink);
      paginationContainer.appendChild(pageButton);
    }
  
    // Next button
    const nextButton = document.createElement("li");
    nextButton.classList.add("page-item");
    const nextLink = document.createElement("a");
    nextLink.classList.add("page-link");
    nextLink.href = `?page=${currentPage + 1}`;
    nextLink.textContent = "Next";
    nextButton.appendChild(nextLink);
    paginationContainer.appendChild(nextButton);
  </script>

<!-- filter -->






<script>

    
    const addProductToCart = async (productId) => {
    try {
        const response = await fetch('/addtoCart', {
            method: 'POST',
            headers: {  
                'Content-Type': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ productId })
        });

        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                // Update cart count in navbar icon
                updateCartItemCount();
            }
        } else {
            console.error('Failed to add product to cart');
        }
    } catch (error) {
        console.error('Error adding product to cart:', error);
    }
};

</script>



<script>
    function toggleWishlist(productId) {
        const wishlistMessage = document.getElementById('wishlist-message');
        const heartIcon = document.getElementById('heart-icon-' + productId);
        const flashMessage = document.getElementById('flash-message');

        // Toggle heart icon color
        if (heartIcon.style.color === 'red') {
            heartIcon.style.color = 'black'; // If red, change to black
        } else {
            heartIcon.style.color = 'red'; // If black, change to red
        }

        // Fetch to add/remove product from wishlist
        fetch(`/addTowishlist/${productId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Display flash message
            if (data.success) {
                flashMessage.textContent = "Product added to wishlist";
                flashMessage.style.color = "green";
                flashMessage.style.display = "block";
                setTimeout(() => {
                    flashMessage.style.display = "none";
                }, 3000); // Hide flash message after 3 seconds
                // Reload the page (optional)
                // window.location.reload();
            } else {
                flashMessage.textContent = data.message; // Display error message
                flashMessage.style.color = "red";
                flashMessage.style.display = "block";
                setTimeout(() => {
                    flashMessage.style.display = "none";
                }, 3000); // Hide flash message after 3 seconds
            }
        })
        .catch(error => {
            console.error('Error in sending addTowishlist request:', error);
            flashMessage.textContent = "An error occurred while processing your request";
            flashMessage.style.color = "red";
            flashMessage.style.display = "block";
            setTimeout(() => {
                flashMessage.style.display = "none";
            }, 3000); // Hide flash message after 3 seconds
        });
}
</script>






<style>
    /* Sidebar search form */
.sidebar-search form {
    display: flex;
    align-items: center;
}

/* Search input field */
.sidebar-search input[type="text"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 0px;
    font-size: 14px;
    color: #333;
}

/* Search button */
.sidebar-search button {
    background-color:#e7ab3c;
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 0px;
    cursor: pointer;
    margin-left: 10px;
}

/* Search button hover effect */
.sidebar-search button:hover {
    background-color: #525353;
}

/* Select option container */
.select-option {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

/* Link styling */
.select-option a {
    text-decoration: none;
    color: #333;
    padding: 8px 16px;
    border: 1px solid #ccc;
    border-radius: 0px;
    transition: all 0.3s ease;
}

/* Link hover effect */
.select-option a:hover {
    background-color:  #e7ab3c;
    color: #fff;
}

/* Sidebar categories container */
.sidebar-categories {
    margin-bottom: 20px;
}

/* List styling */
.sidebar-categories ul {
    list-style-type: none;
    padding: 0;
}

/* List item styling */
.sidebar-categories li {
    margin-bottom: 10px;
}

/* Link styling */
.sidebar-categories li span {
    color: blue;
    cursor: pointer;
    font-size: 16px;
}

/* Link hover effect */
.sidebar-categories li span:hover {
    text-decoration: underline;
}

.flash-message {
    display: none;
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 10px 20px;
    background-color: #fff;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    z-index: 1000;
}

</style>






    <!-- Include Toastr CSS and JavaScript files -->


  

<%- include('../partials/footer.ejs')%>
