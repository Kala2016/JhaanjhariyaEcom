<%- include('../partials/header.ejs') %>

    <!-- Breadcrumb Section Begin -->
    <div class="breacrumb-section">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb-text product-more">
                        <a href="./home"><i class="fa fa-home"></i> Home</a>
                        <a href="./shop">Shop</a>
                        <span>Shopping Cart</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb Section Begin -->

    <!-- Shopping Cart Section Begin -->
    <section class="shopping-cart spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="cart-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th class="p-name">Product Name</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th><i class="ti-close"></i></th>
                                </tr>
                            </thead>
                            <!-- <tbody>
                                <tr>
                                    <td class="cart-pic first-row"><img src="img/cart-page/product-1.jpg" alt=""></td>
                                    <td class="cart-title first-row">
                                        <h5>Pure Pineapple</h5>
                                    </td>
                                    <td class="p-price first-row">$60.00</td>
                                    <td class="qua-col first-row">
                                        <div class="quantity">
                                            <div class="pro-qty">
                                                <input type="text" value="1">
                                            </div>
                                        </div>
                                    </td>
                                    <td class="total-price first-row">$60.00</td>
                                    <td class="close-td first-row"><i class="ti-close"></i></td>
                                </tr>
                                <tr>
                                    <td class="cart-pic"><img src="img/cart-page/product-2.jpg" alt=""></td>
                                    <td class="cart-title">
                                        <h5>American lobster</h5>
                                    </td>
                                    <td class="p-price">$60.00</td>
                                    <td class="qua-col">
                                        <div class="quantity">
                                            <div class="pro-qty">
                                                <input type="text" value="1">
                                            </div>
                                        </div>
                                    </td>
                                    <td class="total-price">$60.00</td>
                                    <td class="close-td"><i class="ti-close"></i></td>
                                </tr>
                                <tr>
                                    <td class="cart-pic"><img src="img/cart-page/product-3.jpg" alt=""></td>
                                    <td class="cart-title">
                                        <h5>Guangzhou sweater</h5>
                                    </td>
                                    <td class="p-price">$60.00</td>
                                    <td class="qua-col">
                                        <div class="quantity">
                                            <div class="pro-qty">
                                                <input type="text" value="1">
                                            </div>
                                        </div>
                                    </td>
                                    <td class="total-price">$60.00</td>
                                    <td class="close-td"><i class="ti-close"></i></td>
                                </tr>
                            </tbody> -->
                            
                            <% let items=cart.items, grandTotal=0; %>
                            <% if(items.length===0){ %>
                                <tr class="table_row text-center">
                                    <th>
                                    <th>
                                    <th class=" display-5 pe-2">
                                        <div class="d-flex">
                                            <i class="bi bi-cart"></i>Cart
                                        </div></th>
                                    <th class="display-5 "> empty!</th>
                                    <th></th>
                                </tr>
                            <% } %>
                                <% items.forEach((item,index)=>{ %>
                                    <% let image=item.product_id.images[0].url; let { brand,model}=item.product_id; let
                                        subtotal=item.variant_id.price * item.quantity; grandTotal+=subtotal; %>
                                        <tr class="table_row" id="row<%= index %>" data-productid="<%= item.product_id._id %>"
                                            data-updated="no" data-stock="<%= item.variant_id.stock %>">
                                            
                                            <td class="column-1">
                                                <div class="how-itemcart1">
                                                    <img src="/products/<%= brand+' '+model+'/'+image %>" alt="image">
                                                </div>
                                            </td>
                                            <td class="column-2 text-dark fw-bold">
                                                <%= brand+" "+model %>
                                                <br><small class=" text-warning fw-normal">Color Selected : </small>
                                                <div class="btn btn-lg" style="background-color: <%= item.variant_id.color %> ;"></div>
                                            </td>
                                            <td class="column-3"><i class="bi bi-currency-rupee"></i>
                                                <span id="price<%= index %>">
                                                    <%= item.variant_id.price.toLocaleString('en-IN') %>
                                                </span>
                                            </td>
                                            <td class="d-flex justify-content-center m-t-65 align-items-center">
                                                <div class="row">
                                                    <button type="button" class="btn btn-secondary border col"
                                                        onclick="updatePrice('sub',<%= index %>)">
                                                        <i class="bi bi-dash-lg"></i>
                                                    </button>
                                                    <input readonly class="border col text-center form-control-sm" type="number"
                                                        id="quantity<%= index %>" name="quantity" value="<%= item.quantity %>">
                                                    <button type="button" class="btn btn-secondary border col"
                                                        onclick="updatePrice('add',<%= index %>)">
                                                        <i class="bi bi-plus-lg"></i>
                                                    </button>
                                                </div>
                                            </td>
                                            <td class="column-5">
                                                <i class="bi bi-currency-rupee" style="font-size: medium;"></i>
                                                <span id="subtotal<%= index %>" class="fw-bold subtotal">
                                                    <%= subtotal %>
                                                </span>
                                            </td>
                                            <td class="">
                                                <button class="mx-4" type="button"
                                                    onclick="cartItemDelete('<%= item.variant_id._id %>','<%= index %>')"><i
                                                        class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                            <% }) %>
							</table> 
                        </table>
                    </div>
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="cart-buttons">
                                <a href="#" class="primary-btn continue-shop">Continue shopping</a>
                                <a href="#" class="primary-btn up-cart">Update cart</a>
                            </div>
                            <div class="discount-coupon">
                                <h6>Discount Codes</h6>
                                <form action="#" class="coupon-form">
                                    <input type="text" placeholder="Enter your codes">
                                    <button type="submit" class="site-btn coupon-btn">Apply</button>
                                </form>
                            </div>
                        </div>
                        <div class="col-lg-4 offset-lg-4">
                            <div class="proceed-checkout">
                                <ul>
                                    <li class="subtotal">Subtotal <span>$240.00</span></li>
                                    <li class="cart-total">Total <span>$240.00</span></li>
                                </ul>
                                <a href="#" class="proceed-btn">PROCEED TO CHECK OUT</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        function updatePrice(action, index) {
            let quantity = document.getElementById(`quantity${index}`);
            let price = parseInt(document.getElementById(`price${index}`).textContent.replace(/,/g, ""))
            let subtotal = document.getElementById(`subtotal${index}`)
            let data = document.getElementById(`row${index}`);
            const MAX_STOCK  = data.dataset.stock;
            let quantityBE,
                stock = Number(MAX_STOCK);
                console.log(stock)

            if (action === "add" && quantity.value != stock) {
                quantityBE = quantity.value = Number(quantity.value) + 1;
                subtotal.innerHTML = price * quantity.value;
                data.dataset.updated = "yes";
            } else if (action === "sub") {
                if (Number(quantity.value) === 1) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Invalid Quantity!',
                        text: "Quantitiy can't be zero",
                        timer: 4000,
                        showConfirmButton: true
                    });
                    quantity.value = 1;
                    return;
                } else {
                    quantityBE = quantity.value = parseInt(quantity.value, 10) - 1;
                    subtotal.textContent = price * quantity.value;
                    data.dataset.updated = "yes";
                }
            }else{
                Toastify({
                    text:"Maximum quantity reached",
                    stopOnfocus:true,
                    duration:1500,
                    gravity:"top",
                    position:"center",
                    offset:{
                        y:50
                    },
                    style:{
                        backgroundColor: "#ff0000",
                    }
                }).showToast();
                return;
            }

            console.log(quantityBE)
            updateGT();
            updateByFetch(index, data, quantityBE);
        }

        function updateGT() {
            let grandTotal = document.getElementById("grandtotal");
            let subtotal = document.querySelectorAll(".subtotal");
            let total = 0;

            subtotal.forEach(sub => {
                total += parseInt(sub.textContent);
            })
            grandTotal.textContent = total.toLocaleString("en-IN");
        }

        function updateByFetch(index, updated, quantityBE) {
            fetch("/updatecart", {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    id: updated.dataset.productid,
                    quantity: quantityBE,
                    index: index
                })
            })
                .then(response => {
                    if (response.ok) {
                        return response.json()
                    }
                })
                .then(result => {
                    console.log(result.success, " : ", result.message);
                })
                .catch(error => {
                    console.log(error.message);
                })

        }

        function cartItemDelete(id, index) {
            fetch("/deletecartitem", {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    itemId: id,
                    index: index
                })
            })
                .then(response => {
                    if (response.ok) {
                        return response.json()
                    }
                })
                .then(result => {
                    if (result.message) {
                        console.log(result.message)
                        updateCartPage(index, result.length0);
                        updateGT();
                    } else {
                        console.log(result.message)
                    }
                })
                .catch(error => {
                    console.log(error.message);
                })

            function updateCartPage(index, length0) {
                let row = document.getElementById(`row${index}`);
                let notify = document.getElementById("notify");
                let notifyValue = Number(notify.dataset.notify);
                notify.dataset.notify = notifyValue - 1;
                row.remove();

                if (length0) {
                    let table = document.createElement("tr")
                    let emptyInfo = `<td><td>
                        <td class="fw-bold display-5 d-flex mt-5 pe-2"><i class="bi bi-cart"></i>Cart</td>
                        <td class="fw-bold display-5 "> empty!</td>
                        <td></td>`
                    table.innerHTML = emptyInfo;
                    table.classList.add("table_row", "text-center")
                    document.getElementById("cartTable").appendChild(table);
                    document.getElementById("grandtotal").textContent = 0;
                }
            }
        }
    </script>
    <div class="d-flex justify-content-center my-3">
            <button class="btn btn-dark py-2 px-5 rounded-pill btn-lg" type="button"
                onclick="goToCheckout(<%= cart.items.length %>)">Proceed to checkout</button>
    </div>
    <script>
        function goToCheckout(length) {
            let grandTotal = document.getElementById("grandtotal").textContent;

            if (length === 0 || (Number(grandTotal) === 0)) {
                Swal.fire({
                    title: "Cart empty!",
                    icon: "warning",
                    timer: 3000,
                    showConfirmButton: false
                })
            } else {
                window.location.href = "/checkout";
            }
        }
    </script>
    
                           

    


    <%-include('../partials/footer.ejs') %>
    